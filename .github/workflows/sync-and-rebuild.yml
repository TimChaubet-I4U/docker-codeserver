# File: .github/workflows/sync-and-rebuild.yml
# Author: Tim Chaubet

name: Sync, Build, and Update

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  sync-and-build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout your repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Merge Upstream Changes
        run: |
          git config --global user.name "Tim Chaubet"
          git config --global user.email "action@github.com"
          git remote add upstream https://github.com/TrueOsiris/docker-codeserver.git
          git fetch upstream main
          git merge upstream/main --strategy-option theirs -m "Merge upstream updates" || echo "No changes"
          rm -f .github/workflows/build-docker-image.yml

      - name: Set Image Name to Lowercase
        run: |
          # Changed from docker-codeserver to codeserver
          IMAGE_PATH="ghcr.io/${{ github.repository_owner }}/codeserver:latest"
          echo "IMAGE_TAG=$(echo $IMAGE_PATH | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV

      - name: Update README Image Reference
        run: |
          # This replaces ANY ghcr.io/timchaubet-i4u/... line with the new one
          # It also handles the transition from the old TrueOsiris line
          sed -i "s|image: ghcr.io/.*codeserver:latest|image: ${{ env.IMAGE_TAG }}|g" README.md
          
          git add README.md
          git commit -m "docs: update README image to ${{ env.IMAGE_TAG }}" || echo "No changes"

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ env.IMAGE_TAG }}

      - name: Standard Push
        run: |
          git push origin main