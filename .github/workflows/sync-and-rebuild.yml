# File: .github/workflows/sync-and-rebuild.yml
# Author: Tim Chaubet

name: Sync, Build, and Update

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  sync-and-build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout your repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Force Sync from TrueOsiris
        run: |
          git config --global user.name "Tim Chaubet"
          git config --global user.email "action@github.com"
          
          git remote add upstream https://github.com/TrueOsiris/docker-codeserver.git
          git fetch upstream main
          
          # 1. Force match upstream
          git checkout main
          git reset --hard upstream/main
          
          # 2. Delete forbidden workflows from upstream
          rm -rf .github/workflows/build-docker-image.yml
          
          # 3. Restore this exact workflow file
          git checkout HEAD@{1} -- .github/workflows/sync-and-rebuild.yml

      - name: Set Image Name to Lowercase
        # This creates a variable $IMAGE_TAG that is always lowercase
        run: |
          IMAGE_PATH="ghcr.io/${{ github.repository }}:latest"
          echo "IMAGE_TAG=$(echo $IMAGE_PATH | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV

      - name: Update README Image Reference
        run: |
          # Uses the lowercase tag from the previous step
          sed -i "s|image: ghcr.io/trueosiris/codeserver:latest|image: ${{ env.IMAGE_TAG }}|g" README.md

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          # Uses the ENV variable to ensure lowercase
          tags: ${{ env.IMAGE_TAG }}

      - name: Commit and Force Push All Changes
        run: |
          git add .
          git commit -m "Sync from TrueOsiris & Update README image reference" || echo "No changes"
          git push origin main --force