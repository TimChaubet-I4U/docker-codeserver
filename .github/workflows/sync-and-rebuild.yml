# File: .github/workflows/sync-and-rebuild.yml
# Author: Tim Chaubet

name: Sync, Build, and Update

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  sync-and-build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout your repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Merge Upstream Changes
        run: |
          git config --global user.name "Tim Chaubet"
          git config --global user.email "action@github.com"
          
          git remote add upstream https://github.com/TrueOsiris/docker-codeserver.git
          git fetch upstream main
          
          # MERGE instead of RESET. This preserves history.
          # '--strategy-option theirs' favors upstream if there is a conflict.
          git merge upstream/main --strategy-option theirs -m "Merge upstream updates" || echo "No changes to merge"
          
          # Cleanup unwanted upstream workflows
          rm -f .github/workflows/build-docker-image.yml

      - name: Set Image Name to Lowercase
        run: |
          IMAGE_PATH="ghcr.io/${{ github.repository }}:latest"
          echo "IMAGE_TAG=$(echo $IMAGE_PATH | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV

      - name: Update README Image Reference
        run: |
          # Update the line to point to your GHCR image
          sed -i "s|image: ghcr.io/trueosiris/codeserver:latest|image: ${{ env.IMAGE_TAG }}|g" README.md
          
          git add README.md
          git commit -m "docs: update README image reference" || echo "No changes"

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ env.IMAGE_TAG }}

      - name: Standard Push
        run: |
          # We use a standard push now. 
          # This allows your codeserver to 'Sync' (Pull) without conflicts.
          git push origin main